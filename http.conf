# httpd.conf additions for sticky sessions

# Load required modules
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
LoadModule status_module modules/mod_status.so
LoadModule headers_module modules/mod_headers.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule rewrite_module modules/mod_rewrite.so

# Configure proxy balancer with sticky sessions
<Proxy balancer://mycluster>
    # Define backend servers with route parameter
    BalancerMember http://localhost:8084 route=tomcat1
    BalancerMember http://localhost:8085 route=tomcat2
    
    # Configure sticky sessions using JSESSIONID cookie
    Header add Set-Cookie "ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/"
    ProxySet stickysession=JSESSIONID
</Proxy>

# Virtual host configuration
<VirtualHost *:80>
    ServerName localhost
    DocumentRoot "D:/Programs/Apache24/htdocs"
    
    # Root directory configuration
    <Directory "D:/Programs/Apache24/htdocs">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # Add index.html to welcome files
    DirectoryIndex index.html
    
    # Proxy configuration
    ProxyPreserveHost On
    ProxyPass /balancer-manager !
    
    # Route handling - support for manual server selection
    RewriteEngine On
    
    # If switching server is requested, use specified route parameter
    RewriteCond %{QUERY_STRING} (?:^|&)switchServer=true(?:&|$)
    RewriteCond %{QUERY_STRING} (?:^|&)route=([^&]+)(?:&|$)
    RewriteRule ^/sessiontest(.*) http://localhost:8084/sessiontest$1? [P,L]
    
    # Direct route specification (without switch)
    RewriteCond %{QUERY_STRING} (?:^|&)route=tomcat1(?:&|$)
    RewriteCond %{QUERY_STRING} !(?:^|&)switchServer=true(?:&|$)
    RewriteRule ^/sessiontest(.*) http://localhost:8084/sessiontest$1 [P,L]
    
    RewriteCond %{QUERY_STRING} (?:^|&)route=tomcat2(?:&|$)
    RewriteCond %{QUERY_STRING} !(?:^|&)switchServer=true(?:&|$)
    RewriteRule ^/sessiontest(.*) http://localhost:8085/sessiontest$1 [P,L]
    
    # Default balancer routing
    ProxyPass / balancer://mycluster/
    ProxyPassReverse / balancer://mycluster/
    
    # Enable balancer manager (for monitoring)
    <Location "/balancer-manager">
        SetHandler balancer-manager
        Require local
    </Location>
    
    # Optional: Enable server status
    <Location "/server-status">
        SetHandler server-status
        Require local
    </Location>
</VirtualHost>