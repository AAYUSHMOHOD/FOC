# httpd.conf additions for sticky sessions

# Load required modules
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
LoadModule status_module modules/mod_status.so

# Configure proxy balancer with sticky sessions
<Proxy balancer://mycluster>
    # Define backend servers with route parameter
    BalancerMember http://localhost:8080 route=tomcat1
    BalancerMember http://localhost:8081 route=tomcat2
    
    # Configure sticky sessions using JSESSIONID cookie
    Header add Set-Cookie "ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/"
    ProxySet stickysession=JSESSIONID
</Proxy>

# Virtual host configuration
<VirtualHost *:80>
    ServerName localhost
    DocumentRoot "C:/Apache24/htdocs"
    
    # Proxy configuration
    ProxyPreserveHost On
    ProxyPass /balancer-manager !
    ProxyPass / balancer://mycluster/
    ProxyPassReverse / balancer://mycluster/
    
    # Enable balancer manager (for monitoring)
    ProxyPass /balancer-manager balancer-manager
    <Location "/balancer-manager">
        SetHandler balancer-manager
        Require local
    </Location>
    
    # Optional: Enable server status
    <Location "/server-status">
        SetHandler server-status
        Require local
    </Location>
</VirtualHost>